# Training Routing Configuration
# Determines whether to train cross-sectional, symbol-specific, both, experimental, or block training
# for each (target, symbol) pair based on metrics from feature selection, stability, and leakage detection

routing:
  # --- View Policy (for E2E testing vs production) ---
  # "view" = modeling granularity: CROSS_SECTIONAL (all symbols together) or SYMBOL_SPECIFIC (per-symbol)
  view_policy: "auto"            # "force" or "auto" - force uses requested_view exactly, auto allows resolver to flip based on panel size
  requested_view: "CROSS_SECTIONAL"  # Only used if view_policy=force - exact view to use (no auto-flip)
  auto_flip_min_symbols: 10      # Only used if view_policy=auto - minimum symbols required for CROSS_SECTIONAL (below this, flips to SYMBOL_SPECIFIC)
  
  # DEPRECATED: mode_policy and requested_mode are renamed to view_policy and requested_view
  # Legacy aliases kept for backward compatibility - remove after migration complete
  # mode_policy: alias for view_policy
  # requested_mode: alias for requested_view
  
  # --- Dev Mode (for testing with smaller datasets) ---
  dev_mode: true                 # If true, use adaptive thresholds for smaller datasets
  dev_mode_min_sample_size: 1_000  # Minimum sample size when dev_mode is enabled (lowered for small datasets)
  auto_dev_mode_threshold: 10_000  # Auto-enable dev_mode if max_samples_per_symbol < this value
  
  # --- General Safety Rails ---
  min_sample_size:
    cross_sectional: 5_000       # Total rows required for CS training (lowered for small datasets)
    symbol: 1_000                # Per-symbol rows required for symbol-specific training (lowered for small datasets)
  
  block_on_leakage: true         # Block training if leakage detected
  
  # --- Score Thresholds ---
  # Task-type aware: different thresholds for classification (AUC) vs regression (R²)
  # Classification: AUC range is 0.5 (random) to 1.0 (perfect)
  # Regression: R² range is -inf to 1.0 (0 = predicting mean, negative = worse than mean)
  # Horizon-aware: longer horizons are inherently harder to predict, so thresholds are relaxed
  cross_sectional:
    min_score:
      classification: 0.52       # AUC slightly above random (0.5)
      regression:                # Horizon-aware R² thresholds
        default: -0.5            # Fallback if horizon unknown
        short: 0.0               # < 60 min: expect positive R²
        medium: -0.3             # 60min - 4h: allow slightly negative
        long: -1.0               # 4h - 1d: allow poor fits
        very_long: -2.0          # > 1d: allow very poor fits (inherently hard)
    strong_score:
      classification: 0.58       # AUC threshold for "strong" CS signal
      regression:                # Horizon-aware R² thresholds for "strong" signal
        default: 0.05            # Fallback if horizon unknown
        short: 0.15              # < 60 min: higher expectations
        medium: 0.10             # 60min - 4h
        long: 0.0                # 4h - 1d: break-even is good
        very_long: -0.5          # > 1d: slightly negative is acceptable
  
  symbol:
    min_score:
      classification: 0.54       # AUC slightly higher for symbol-specific
      regression:                # Horizon-aware R² thresholds
        default: -0.3            # Fallback if horizon unknown
        short: 0.05              # < 60 min: expect positive R²
        medium: -0.2             # 60min - 4h
        long: -0.8               # 4h - 1d
        very_long: -1.5          # > 1d
    strong_score:
      classification: 0.60       # AUC threshold for "strong" symbol signal
      regression:                # Horizon-aware R² thresholds for "strong" signal
        default: 0.10            # Fallback if horizon unknown
        short: 0.20              # < 60 min
        medium: 0.15             # 60min - 4h
        long: 0.05               # 4h - 1d
        very_long: -0.3          # > 1d
  
  # --- Stability Requirements ---
  # Stability categories: STABLE, DRIFTING, DIVERGED, UNKNOWN
  # NOTE: UNKNOWN is allowed for first runs (no prior snapshots to compare)
  stability_allowlist:
    cross_sectional: ["STABLE", "DRIFTING", "UNKNOWN"]  # CS can tolerate some drift + first runs
    symbol: ["STABLE", "UNKNOWN"]                       # Symbol-specific requires stability + first runs
  
  # --- Both Strong Behavior ---
  # When both CS and symbol are strong, what to do?
  both_strong_behavior: "ROUTE_BOTH"  # Options: "ROUTE_BOTH", "PREFER_CS", "PREFER_SYMBOL"
  
  # --- Experimental Lane ---
  enable_experimental_lane: true
  experimental:
    min_score: 0.52              # Lower threshold for experimental
    allowed_stabilities: ["DRIFTING", "UNKNOWN"]  # Experimental can handle instability
    max_fraction_symbols_per_target: 0.2  # Cap experiment load (20% of symbols per target)
  
  # --- Feature Set Safety ---
  require_safe_features_only: true
  allowed_feature_leakage_status: ["SAFE"]  # Only use features marked as SAFE
  
  # --- Model Family Failure Handling ---
  # If all major model families fail, block training
  require_min_successful_families: 1  # Minimum families that must succeed
  
  # --- Logging Options ---
  log_decision_reasons: true
  dump_plan_as:
    - "JSON"
    - "YAML"
    - "MARKDOWN"
  
  # --- Stability Classification Rules ---
  # How to classify stability from metrics
  stability_classification:
    # Thresholds for mean_overlap (Jaccard similarity of top-K features)
    stable_overlap_min: 0.70
    drifting_overlap_min: 0.50
    
    # Thresholds for mean_tau (Kendall tau rank correlation)
    stable_tau_min: 0.60
    drifting_tau_min: 0.40
    
    # If std_overlap or std_tau is high, mark as DIVERGED
    max_std_overlap: 0.20
    max_std_tau: 0.25
    
    # Minimum snapshots required for stability analysis
    min_snapshots_for_stability: 2
