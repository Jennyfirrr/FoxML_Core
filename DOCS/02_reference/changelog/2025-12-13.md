# Changelog ‚Äî 2025-12-13

**Config Path Consolidation, Config Trace System, Max Samples Fix, Output Directory Binning Fix**

For a quick overview, see the [root changelog](../../../CHANGELOG.md).  
For other dates, see the [changelog index](README.md).

---

## Added

### Config Path Consolidation & Centralization

**Major Config Structure Reorganization**
- **Enhancement**: Reorganized entire `CONFIG/` directory into a more human-usable, modular structure
- **New Structure**:
  ```
  CONFIG/
  ‚îú‚îÄ‚îÄ core/              # Core system configs (logging, system)
  ‚îú‚îÄ‚îÄ data/              # Data-related configs (excluded_features, feature_registry, etc.)
  ‚îú‚îÄ‚îÄ models/            # Model-specific configs (lightgbm, xgboost, etc.)
  ‚îú‚îÄ‚îÄ pipeline/          # Pipeline configs
  ‚îÇ   ‚îú‚îÄ‚îÄ training/      # Training-specific configs
  ‚îÇ   ‚îî‚îÄ‚îÄ *.yaml         # Pipeline-level configs (gpu, memory, threading, pipeline)
  ‚îú‚îÄ‚îÄ ranking/           # Ranking configs
  ‚îÇ   ‚îú‚îÄ‚îÄ features/      # Feature selection configs
  ‚îÇ   ‚îî‚îÄ‚îÄ targets/       # Target ranking configs
  ‚îî‚îÄ‚îÄ experiments/       # Experiment configs (unchanged)
  ```
- **Backward Compatibility**: Created symlinks from old locations to new locations
- **Migration**: All config loaders updated to check new locations first, then fall back to old
- **Files**:
  - `CONFIG/config_loader.py` - Added `get_config_path()` helper function
  - `CONFIG/config_builder.py` - Updated all builders to check new locations

**Benefits**:
- ‚úÖ More intuitive organization (data configs together, training configs together, etc.)
- ‚úÖ Easier to find and maintain configs
- ‚úÖ Clear separation of concerns
- ‚úÖ Backward compatible (symlinks + fallback logic)
- ‚úÖ No breaking changes (all loaders check both old and new locations)

### Config Trace System

**Comprehensive Configuration Tracing & Provenance**
- **Enhancement**: Added detailed config trace logging to show where each config value comes from
- **Purpose**: Diagnose config loading issues, precedence conflicts, and override problems
- **Features**:
  - Shows all loaded config files in order
  - Shows source chain for each key config value
  - Detects and reports conflicts
  - Shows working directory and environment info
  - Logs before data loading so you can verify values are correct
- **Implementation**:
  - `TRAINING/orchestration/intelligent_trainer.py` - Added config trace logging in `main()`
  - `TRAINING/ranking/predictability/model_evaluation.py` - Added config trace in `evaluate_target_predictability()`
- **Output Example**:
  ```
  ================================================================================
  üìã CONFIG TRACE: Configuration Loading and Precedence
  ================================================================================
  üìÅ Loaded config files (in order):
    1. intelligent_training_config.yaml
       ‚Üí /home/Jennifer/trader/CONFIG/pipeline/training/intelligent.yaml
    2. experiment: e2e_full_targets_test.yaml
       ‚Üí /home/Jennifer/trader/CONFIG/experiments/e2e_full_targets_test.yaml

  üîç Key Config Values (with source chain):
     data.max_rows_per_symbol: 1000
       1. ‚Üí intelligent_training_config.yaml ‚Üí data.max_rows_per_symbol = 10000
       2. ‚úì experiment: e2e_full_targets_test.yaml ‚Üí data.max_samples_per_symbol = 1000 (OVERRIDE)
  ```
- **Benefits**:
  - Immediately see where config values come from
  - Catch config loading issues before they cause problems
  - Understand precedence and overrides
  - Debug config-related issues faster

### Output Directory Binning Based on Config Limits

**Dynamic Output Directory Organization**
- **Enhancement**: Output directory binning now uses configured `max_rows_per_symbol` instead of estimating from full dataset
- **Before**: Estimated from actual data files ‚Üí `sample_500k-1M` (full dataset size)
- **After**: Uses configured limits ‚Üí `max_rows_per_symbol=1000` √ó 5 symbols = 5000 ‚Üí `sample_5k-10k`
- **Implementation**:
  - `TRAINING/orchestration/intelligent_trainer.py`:
    - Added `max_rows_per_symbol` and `max_cs_samples` parameters to `__init__()`
    - Updated `_estimate_n_effective_early()` to prioritize configured limits
    - Falls back to experiment config YAML if parameters not provided
    - Falls back to data file estimation if no config available
- **Priority Order**:
  1. Configured `max_rows_per_symbol` parameter (from merged config)
  2. Experiment config YAML `data.max_rows_per_symbol` or `data.max_samples_per_symbol`
  3. Existing metadata from previous runs
  4. Data file estimation (original method)
- **Benefits**:
  - Output directory reflects actual data limits being used, not full dataset size
  - Runs with same config limits are grouped together (e.g., all 1000-row runs)
  - More accurate organization for comparison
  - Easier to find runs with specific data limits

## Fixed

### Max Samples Not Being Read from Experiment Config

**Critical Config Loading Fix**
- **Issue**: `max_samples_per_symbol` and `max_rows_per_symbol` from experiment config YAML were not being merged into `data_cfg`
- **Symptom**: Logs showed `max_rows_per_symbol: 10000` from `intelligent_training_config.yaml` even when experiment config had `max_samples_per_symbol: 1000`
- **Root Cause**: YAML merge logic only read `min_cs`, `max_cs_samples`, and `max_rows_train` - didn't read `max_samples_per_symbol` or `max_rows_per_symbol`
- **Fix**:
  - Updated `TRAINING/orchestration/intelligent_trainer.py` to read ALL data section keys from experiment YAML
  - Now reads: `min_cs`, `max_cs_samples`, `max_rows_train`, `max_samples_per_symbol`, `max_rows_per_symbol`
  - Updated config trace to show experiment config overrides
- **Files**:
  - `TRAINING/orchestration/intelligent_trainer.py` - Fixed YAML merge logic (lines 1887-1896)
  - `TRAINING/ranking/predictability/model_evaluation.py` - Added experiment config check for `max_rows_per_symbol` and `max_cs_samples`
- **Impact**: Experiment config data limits now correctly override intelligent training config defaults

### Config Trace in Model Evaluation

**Enhanced Config Provenance in Ranking**
- **Enhancement**: Added comprehensive config trace logging in `evaluate_target_predictability()`
- **Features**:
  - Shows working directory
  - Shows experiment config name
  - Shows resolved values with source provenance for:
    - `max_rows_per_symbol`
    - `max_cs_samples`
    - `min_cs`
- **Implementation**:
  - `TRAINING/ranking/predictability/model_evaluation.py` - Added config trace block before data loading
- **Benefits**:
  - Immediately see where data limits come from
  - Catch config issues before data loading
  - Debug ranking-specific config problems

## Changed

### Config Loader Fallback Logic

**Improved Config Path Resolution**
- **Enhancement**: All config loaders now check new locations first, then fall back to old
- **Implementation**:
  - `CONFIG/config_loader.py` - Added `get_config_path()` helper function
  - All loaders updated to use new structure with fallbacks
- **Backward Compatibility**: Symlinks + fallback logic ensure no breaking changes

### Training Config Warning Level

**Reduced Noise in Logs**
- **Change**: Changed `training_config.yaml` not found warning from `WARNING` to `DEBUG`
- **Reason**: This is often handled gracefully by defaults, so it's not a real error
- **File**: `CONFIG/config_loader.py`
- **Impact**: Cleaner logs, less noise for expected behavior

## Documentation

### Updated Config Documentation

- **CONFIG/README.md** - Updated with new modular structure
- **DOCS/02_reference/configuration/migration/MIGRATION_GUIDE.md** - Quick reference for old ‚Üí new paths
- **DOCS/02_reference/configuration/migration/CLEANUP_PLAN.md** - Detailed migration plan
- **DOCS/02_reference/configuration/migration/PATH_CONSOLIDATION.md** - Status tracking
- **DOCS/02_reference/configuration/migration/BROKEN_PATHS_CHECK.md** - Verification that no paths are broken
- **DOCS/02_reference/configuration/migration/CONFIG_TRACE_FIX.md** - Documentation of config trace system

### Documentation Organization

**Index Files & Structure**
- **Enhancement**: Created README.md index files for all DOCS subdirectories
- **New Index Files**:
  - `DOCS/00_executive/README.md` - Executive documentation index
  - `DOCS/01_tutorials/README.md` - Main tutorials index
  - `DOCS/01_tutorials/configuration/README.md` - Configuration tutorials index
  - `DOCS/01_tutorials/training/README.md` - Training tutorials index
  - `DOCS/01_tutorials/setup/README.md` - Setup tutorials index
  - `DOCS/01_tutorials/pipelines/README.md` - Pipeline tutorials index
  - `DOCS/02_reference/README.md` - Main reference index
  - `DOCS/02_reference/api/README.md` - API reference index
  - `DOCS/02_reference/data/README.md` - Data reference index
  - `DOCS/02_reference/models/README.md` - Models reference index
  - `DOCS/02_reference/systems/README.md` - Systems reference index
  - `DOCS/03_technical/README.md` - Main technical index
  - `DOCS/03_technical/implementation/README.md` - Implementation index
  - `DOCS/03_technical/research/README.md` - Research index
  - `DOCS/03_technical/design/README.md` - Design index
  - `DOCS/03_technical/benchmarks/README.md` - Benchmarks index
  - `DOCS/03_technical/fixes/README.md` - Fixes index
  - `DOCS/03_technical/testing/README.md` - Testing index
  - `DOCS/03_technical/operations/README.md` - Operations index
  - `DOCS/03_technical/refactoring/README.md` - Refactoring index
  - `DOCS/03_technical/roadmaps/README.md` - Roadmaps index
- **Main INDEX.md**: Updated with brief descriptions of each directory tier and links to README files

**Config Migration Documentation**
- **Moved**: Scattered CONFIG documentation files to `DOCS/02_reference/configuration/migration/`
  - `CONFIG/CLEANUP_PLAN.md` ‚Üí `DOCS/02_reference/configuration/migration/CLEANUP_PLAN.md`
  - `CONFIG/MIGRATION_GUIDE.md` ‚Üí `DOCS/02_reference/configuration/migration/MIGRATION_GUIDE.md`
  - `CONFIG/PATH_CONSOLIDATION.md` ‚Üí `DOCS/02_reference/configuration/migration/PATH_CONSOLIDATION.md`
  - `CONFIG/CONFIG_TRACE_FIX.md` ‚Üí `DOCS/02_reference/configuration/migration/CONFIG_TRACE_FIX.md`
  - `CONFIG/BROKEN_PATHS_CHECK.md` ‚Üí `DOCS/02_reference/configuration/migration/BROKEN_PATHS_CHECK.md`
  - `CONFIG/UNUSED_CONFIG_FILES.md` ‚Üí `DOCS/02_reference/configuration/migration/UNUSED_CONFIG_FILES.md`
- **Created**: `DOCS/02_reference/configuration/migration/README.md` - Index for migration documentation

**Root Document Cleanup**
- **CHANGELOG.md**: Condensed to skimmable format with links to detailed changelogs
- **README.md**: Condensed to high-level overview with links to detailed documentation
- **ROADMAP.md**: Condensed to status summary with links to detailed roadmap
- **Cross-Linking**: Fixed all broken cross-links after file moves

**Benefits**:
- ‚úÖ Easier navigation with index files in every directory
- ‚úÖ Clearer organization of scattered documentation
- ‚úÖ More skimmable root documents
- ‚úÖ All cross-links verified and working

### Updated Testing Documentation

- **DOCS/01_tutorials/training/TESTING_QUICK_REFERENCE.md** - Updated config paths
- **DOCS/01_tutorials/training/E2E_TEST_COMMAND.md** - Updated config paths
- **DOCS/01_tutorials/configuration/CONFIG_EXAMPLES.md** - Updated config paths

## Testing

### Verification

To verify config path consolidation:
1. Run any training command - should work with both old and new paths
2. Check logs for config trace output - should show loaded files and sources
3. Verify output directory binning - should reflect configured limits, not full dataset size

To verify max samples fix:
1. Set `max_samples_per_symbol: 1000` in experiment config
2. Run training - should see `max_rows_per_symbol: 1000` in config trace
3. Check output directory - should be in `sample_5k-10k` (not `sample_500k-1M`)

## Migration Notes

### For Users

- **No action required** - All old paths still work via symlinks and fallback logic
- **Recommended**: Update any scripts that reference old paths to use new paths
- **Helper**: Use `CONFIG.config_loader.get_config_path(config_name)` for dynamic path resolution

### For Developers

- **New configs**: Place in new structure (see `DOCS/02_reference/configuration/CONFIG_README.md`)
- **Old configs**: Will continue to work, but consider migrating
- **Path resolution**: Use `get_config_path()` helper function

## Files Modified

### Config System
- `CONFIG/config_loader.py` - Added `get_config_path()`, updated fallback logic
- `CONFIG/config_builder.py` - Updated all builders to check new locations
- `DOCS/02_reference/configuration/CONFIG_README.md` - Updated with new structure
- `DOCS/02_reference/configuration/migration/MIGRATION_GUIDE.md` - New migration guide
- `DOCS/02_reference/configuration/migration/CLEANUP_PLAN.md` - Migration plan
- `DOCS/02_reference/configuration/migration/PATH_CONSOLIDATION.md` - Status tracking
- `DOCS/02_reference/configuration/migration/BROKEN_PATHS_CHECK.md` - Verification results
- `DOCS/02_reference/configuration/migration/CONFIG_TRACE_FIX.md` - Config trace documentation

### Training System
- `TRAINING/orchestration/intelligent_trainer.py` - Config trace, max samples fix, output dir binning fix
- `TRAINING/ranking/predictability/model_evaluation.py` - Config trace, experiment config check

### Overview

Implemented comprehensive Single Source of Truth (SST) enforcement design that eliminates split-brain across all training paths (target ranking and feature selection, both cross-sectional and symbol-specific views).

### Key Changes

- **EnforcedFeatureSet Contract**: New dataclass represents authoritative state after enforcement with set/ordered fingerprints
- **Type Boundary Wiring**: All enforcement stages use `EnforcedFeatureSet` and slice X immediately (no rediscovery)
- **Boundary Assertions**: Reusable `assert_featureset_fingerprint()` validates featureset integrity at all key boundaries
- **Full Coverage**: Implemented across target ranking and feature selection, both CROSS_SECTIONAL and SYMBOL_SPECIFIC views
- **Canonical Map Reuse**: `canonical_lookback_map` parameter enables SST reuse across stages
- **Pre-Enforcement Purge Guard**: Prevents early purge inflation from features that will be dropped by gatekeeper

### Files Changed

- `TRAINING/utils/lookback_cap_enforcement.py`: Added `EnforcedFeatureSet` dataclass, `to_enforced_set()` method
- `TRAINING/utils/lookback_policy.py`: Added `LookbackPolicy` dataclass, `resolve_lookback_policy()`, `assert_featureset_fingerprint()`

